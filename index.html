<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¼¢å­—å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ  V7 - Complete</title>
    <style>
        /* --- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ§˜æä¾›ã®å®Œç’§ãªã‚¹ã‚¿ã‚¤ãƒ«å®šç¾© (ã“ã“ã‹ã‚‰) --- */
        :root {
            --ink-black: #000000;
            --main-font: "UD Digital Kyokasho N-R", "UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“ N-R", sans-serif;
            --border-width: 2px;
            --border-color: #000; 
            --color-perfect: #27ae60; 
            --color-review: #e67e22;
            --color-action: #3498db;
            --paper-bg: #fffdf5; /* ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ç”¨ã«è¿½åŠ  */
        }

        body { 
            margin: 0; 
            font-family: var(--main-font); 
            background: #e0d8c3; 
            overflow: hidden; 
        }

        @media print {
            @page { size: A4 landscape; margin: 0; }
            body { 
                background: white !important; 
                overflow: visible !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .view-header, #menu-screen, #app-practice, #loading-overlay, #update-btn-fixed { display: none !important; }
            .screen-overlay { position: static !important; background: white !important; }
            #view-mode-container { display: block !important; height: auto !important; padding: 0 !important; }
            .view-canvas { 
                width: 285mm !important; height: 185mm !important; margin: 5mm auto !important;
                border: var(--border-width) solid var(--border-color) !important; 
                box-shadow: none !important; 
                page-break-after: always !important; 
            }
            .view-canvas:last-child { page-break-after: auto !important; }
            .ans-text { color: black !important; opacity: 1 !important; visibility: visible !important; }
            .ans-wrapper::before { content: none !important; }
            .square-mark { display: none !important; }
            .square { border: 1px solid #000 !important; } /* å°åˆ·æ™‚ã¯ç©ºæ¬„ã®æ ã®ã¿è¡¨ç¤º */
        }

        .screen-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f0f0f0; z-index: 100;
        }

        .view-header {
            width: 100%; height: 50px; display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; box-sizing: border-box; background: #fff; border-bottom: 1px solid #ccc;
        }

        #view-mode-container {
            height: calc(100vh - 50px); display: flex; align-items: center; justify-content: center;
            padding: 10px; box-sizing: border-box; overflow-y: auto;
        }

        .view-canvas {
            display: flex; flex-direction: row-reverse;
            height: 96%; width: 96vw; max-width: 1600px;
            background: white; 
            border: var(--border-width) solid var(--border-color);
            box-sizing: border-box; padding: 20px; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .kanji-table-grid {
            display: flex; flex-direction: row-reverse;
            height: 100%; flex-grow: 1; 
            border: var(--border-width) solid var(--border-color);
            background: var(--border-color); 
            gap: var(--border-width);        
            overflow: hidden; box-sizing: border-box; 
        }

        .column-unit { 
            border-collapse: collapse; 
            height: 100%; 
            flex: 1; 
            width: auto; 
            table-layout: fixed; 
            background: white; 
            box-sizing: border-box; 
            border: none; 
        }
        
        .column-unit td { 
            border-bottom: var(--border-width) solid var(--border-color); 
            border-left: none; 
            border-right: none;
            border-top: none;
            text-align: center; 
            vertical-align: middle; 
            padding: 0; 
            box-sizing: border-box; 
        }

        .column-unit tr:last-child td { border-bottom: none; }
        
        .h-check { height: 10%; }
        .h-num   { height: 6%; font-size: 1.4vh; }
        .h-ques { 
            height: 53%; writing-mode: vertical-rl; text-orientation: upright; text-align: left; 
            padding: 12px 2px; font-size: min(1.9vh, 17px); line-height: 1.4; vertical-align: middle; 
        }
        .h-num2  { height: 6%; font-size: 1.4vh; }
        .h-ans { height: 25%; position: relative; transition: background 0.1s; }
        
        .ques-wrapper { display: block; width: 100%; height: 100%; text-align: left; }
        .invisible-text { visibility: hidden; pointer-events: none; }
        
        body.view-mode-active .h-ans.has-data { cursor: pointer; }
        body.view-mode-active .h-ans.has-data:hover { background-color: #f0f8ff; }
        
        .ans-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            writing-mode: vertical-rl; text-orientation: upright;
            pointer-events: none;
        }

        .ans-wrapper.show-hint::before {
            content: "ï¼Ÿ"; color: #eee; font-size: 3vh; font-weight: bold;
            position: absolute; z-index: 0;
        }

        .ans-text { font-size: 2.3vh; font-weight: bold; color: #e74c3c; line-height: 1; transition: opacity 0.2s; z-index: 1; }
        .ans-text.blind { opacity: 0; }

        .print-title {
            writing-mode: vertical-rl; font-weight: bold; 
            border: var(--border-width) solid var(--border-color); 
            border-left: 4px double #000;
            padding: 0 15px; display: flex; align-items: center; font-size: 1.3rem;
            height: 100%; margin-left: 15px; box-sizing: border-box; background: white;
        }

        .square { 
            width: 20px; height: 20px; 
            border: 1px solid #000; 
            margin: auto; 
            display: flex; align-items: center; justify-content: center;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            user-select: none;
        }
        .square.hidden { visibility: hidden; pointer-events: none; } 
        
        .mark-perfect { color: var(--color-perfect); } 
        .mark-review { color: var(--color-review); font-size: 14px; }  

        body.view-mode-active .square:hover { background-color: #f9f9f9; }

        .btn-action { padding: 6px 16px; border-radius: 20px; border: 1px solid #333; cursor: pointer; font-weight: bold; background: white; }
        .btn-action:hover { background: #f5f5f5; }
        .btn-action:disabled { opacity: 0.3; cursor: not-allowed; }

        .header-hint { font-size: 0.85rem; color: #e74c3c; margin-left: 10px; font-weight: normal; }

        #menu-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; gap: 30px; background: #e0d8c3;
        }
        .menu-card {
            background: white; padding: 40px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center;
        }
        .select-box { padding: 12px; font-size: 1.1rem; width: 300px; margin-bottom: 20px; border: 2px solid #ccc; border-radius: 8px; }
        .btn-group { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;}
        .btn-main { padding: 12px 25px; font-size: 1rem; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; }
        .btn-view { background: var(--color-action); }
        .btn-print { background: var(--color-perfect); }
        .btn-practice { background: #e67e22; } /* ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ç”¨ã«è¿½åŠ  */
        .btn-main:hover { opacity: 0.8; transform: translateY(-2px); }

        /* --- ã“ã“ã‹ã‚‰æ©Ÿèƒ½çµ±åˆç”¨ã«è¿½åŠ ã—ãŸã‚¹ã‚¿ã‚¤ãƒ« --- */
        
        /* ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ãƒœã‚¿ãƒ³ */
        #update-btn-fixed {
            position: fixed; top: 10px; left: 10px;
            background: white; border: 2px solid #333;
            padding: 8px 12px; border-radius: 8px; cursor: pointer;
            font-weight: bold; font-size: 12px; box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        }
        #update-btn-fixed:active { transform: translate(1px,1px); box-shadow: none; }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; color: var(--color-action); font-weight: bold;
            transition: opacity 0.3s; pointer-events: none;
        }

        /* ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ (æ—§V5ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ–°ãƒ‡ã‚¶ã‚¤ãƒ³ã«é©åˆ) */
        #app-practice {
            display: none; height: 100vh; background: #e0d8c3;
            grid-template-columns: 1fr 1.5fr 1fr; grid-template-rows: 1fr auto;
            gap: 20px; padding: 20px; box-sizing: border-box;
        }
        .p-box {
            background: #fff; border: 4px solid var(--border-color); border-radius: 20px;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden;
        }
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 900px) {
            #app-practice { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; gap: 10px; }
            .p-hide-mobile { display: none; }
        }
    </style>
</head>
<body>

<div id="loading-overlay">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>

<button id="update-btn-fixed" onclick="fetchData(true)">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°</button>

<div id="menu-screen">
    <div class="menu-card">
        <h1 style="margin-top:0;">æ¼¢å­—å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>å­¦ç¿’ã™ã‚‹ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        
        <select id="sheet-select" class="select-box">
            <option disabled selected>èª­ã¿è¾¼ã¿ä¸­...</option>
        </select>
        
        <div id="progress-display" style="margin-bottom:20px; font-weight:bold; color:#666;"></div>

        <div class="btn-group">
            <button class="btn-main btn-view" onclick="startApp('view')">ç”»é¢ã§å­¦ç¿’</button>
            <button class="btn-main btn-practice" onclick="startApp('practice')">ï¼‘å•ãšã¤ç·´ç¿’</button>
            <button class="btn-main btn-print" onclick="startApp('print')">PDF/å°åˆ·</button>
        </div>
    </div>
</div>

<div id="app-view" class="screen-overlay">
    <div class="view-header">
        <div style="display:flex; gap:10px;">
            <button class="btn-action" onclick="goBack()" style="background:#ff4757; color:white; border:none;">Ã— é–‰ã˜ã‚‹</button>
            <button id="toggle-all-btn" class="btn-action" onclick="toggleAllAnswers()">ç­”ãˆã‚’è¡¨ç¤º</button>
        </div>

        <div id="page-info-container" style="display:flex; align-items:center;">
            <div id="page-info" style="font-weight:bold;"></div>
            <span class="header-hint" id="header-hint-text">â€» ãƒã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ç­”ãˆåˆã‚ã›</span>
        </div>
        
        <div id="nav-controls">
            <button id="prevBtn" class="btn-action" onclick="changePage(-1)">â† å‰ã¸</button>
            <button id="nextBtn" class="btn-action" onclick="changePage(1)">æ¬¡ã¸ â†’</button>
        </div>
    </div>

    <div id="view-mode-container"></div>
</div>

<div id="app-practice">
    <div class="p-box p-hide-mobile" style="padding:20px; justify-content:space-between;">
        <h3 style="margin:0; text-align:center;">å­¦ç¿’ã®è¨˜éŒ²</h3>
        <div style="font-size:18px; line-height:2;">
            <div>é€²æ—: <span id="p-stat-total">0/0</span></div>
            <div style="color:var(--color-perfect)">å®Œãºã: <span id="p-stat-perfect">0</span></div>
            <div style="color:var(--color-review)">ã¾ã : <span id="p-stat-retry">0</span></div>
        </div>
        <button class="btn-action" onclick="goBack()" style="width:100%; margin-top:20px;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
    </div>

    <div class="p-box" style="align-items:center; padding:20px; justify-content: center;">
        <div id="p-ans-area" style="font-size: clamp(60px, 8vw, 100px); color: var(--color-review); font-weight: bold; writing-mode: vertical-rl; visibility: hidden; min-height: 200px;"></div>
        
        <div style="margin-top:30px; display:flex; flex-direction:column; gap:15px; width:100%; max-width: 300px;">
            <button id="p-show-btn" class="btn-main btn-view" style="width:100%; padding:20px; font-size:1.2rem;" onclick="showPracticeAnswer()">ç­”ãˆã‚’è¦‹ã‚‹</button>
            <div id="p-judge-btns" style="display:none; gap:10px;">
                <button class="btn-main" style="background:var(--color-perfect); flex:1;" onclick="recordPractice('perfect')">å®Œãºãï¼</button>
                <button class="btn-main" style="background:var(--color-review); flex:1;" onclick="recordPractice('retry')">ã¾ã </button>
            </div>
        </div>
    </div>

    <div class="p-box">
        <div style="padding:10px; text-align:center; border-bottom:2px solid #ccc; font-weight:bold; background:#f9f9f9;" id="p-q-num">ç¬¬ 1 å•</div>
        <div id="p-q-text" style="flex-grow:1; writing-mode:vertical-rl; font-size:clamp(24px, 4vw, 32px); padding:20px; line-height:2; overflow-y:auto;"></div>
    </div>
</div>

<script>
    // â˜…â˜…â˜…ã“ã“ã«GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„â˜…â˜…â˜…
    const API_URL = "https://script.google.com/macros/s/AKfycbyWHprvWe-NcrfamWL2I6bWSAak6HW-JxyMCY-RZkZDFrhLkbSfLkeVmpKyznlI7g3a/exec"; 
    
    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    const CACHE_KEY = "kanji_system_data_v7";
    const PROGRESS_KEY = "kanji_system_progress_v7";
    
    let allData = {};      // å…¨ãƒ‡ãƒ¼ã‚¿ { "ã‚·ãƒ¼ãƒˆå": [å•é¡Œé…åˆ—...] }
    let allProgress = {};  // é€²æ—ãƒ‡ãƒ¼ã‚¿ { "ã‚·ãƒ¼ãƒˆå": { perfect: [], retry: [], lastIndex: 0 } }
    
    // ç¾åœ¨ã®çŠ¶æ…‹
    let currentSheetName = "";
    let currentQuestions = [];
    let currentPage = 0;
    const itemsPerPage = 15;
    let currentMode = 'view'; // 'view' | 'print' | 'practice'
    let isAllAnswersVisible = false;
    
    // ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ç”¨å¤‰æ•°
    let pCurrentIndex = 0;

    // --- åˆæœŸåŒ– ---
    async function init() {
        // é€²æ—ã®èª­ã¿è¾¼ã¿
        const savedProg = localStorage.getItem(PROGRESS_KEY);
        if (savedProg) {
            allProgress = JSON.parse(savedProg);
        }

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        const cachedData = localStorage.getItem(CACHE_KEY);
        if (cachedData) {
            allData = JSON.parse(cachedData);
            renderMenuOptions();
            document.getElementById('loading-overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 300);
        }

        // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—
        fetchData(false);
    }

    async function fetchData(isManual) {
        if (isManual) {
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-overlay').style.opacity = '1';
        }
        
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            allData = data;
            localStorage.setItem(CACHE_KEY, JSON.stringify(data));
            renderMenuOptions();
            if (isManual) alert("ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
        } catch (e) {
            console.error(e);
            if (isManual) alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");
        } finally {
            document.getElementById('loading-overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 300);
        }
    }

    // --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ“ä½œ ---
    function renderMenuOptions() {
        const select = document.getElementById('sheet-select');
        const currentVal = select.value;
        select.innerHTML = "";
        
        const names = Object.keys(allData);
        if (names.length === 0) {
            select.innerHTML = "<option disabled>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</option>";
            return;
        }

        names.forEach((name, idx) => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.innerText = name + ` (å…¨${allData[name].length}å•)`;
            if (idx === 0) opt.selected = true;
            select.appendChild(opt);
        });

        if (currentVal && names.includes(currentVal)) {
            select.value = currentVal;
        }
        
        // é€²æ—è¡¨ç¤ºæ›´æ–°
        updateMenuProgress();
        select.addEventListener('change', updateMenuProgress);
    }

    function updateMenuProgress() {
        const name = document.getElementById('sheet-select').value;
        if (!name || !allData[name]) return;
        
        initProgressIfEmpty(name);
        const prog = allProgress[name];
        const total = allData[name].length;
        
        document.getElementById('progress-display').innerHTML = `
            <span style="color:var(--color-perfect)">å®Œãºã: ${prog.perfect.length}</span> / 
            <span style="color:var(--color-review)">ã¾ã : ${prog.retry.length}</span> / å…¨${total}å•
        `;
    }

    function initProgressIfEmpty(name) {
        if (!allProgress[name]) {
            allProgress[name] = { perfect: [], retry: [], lastIndex: 0 };
        }
    }

    function saveProgress() {
        localStorage.setItem(PROGRESS_KEY, JSON.stringify(allProgress));
    }

    // --- ã‚¢ãƒ—ãƒªèµ·å‹• (ãƒ¢ãƒ¼ãƒ‰åˆ†å²) ---
    function startApp(mode) {
        currentSheetName = document.getElementById('sheet-select').value;
        if (!currentSheetName || !allData[currentSheetName]) {
            alert("ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„");
            return;
        }

        currentQuestions = allData[currentSheetName];
        initProgressIfEmpty(currentSheetName);
        currentMode = mode;

        document.getElementById('menu-screen').style.display = 'none';

        if (mode === 'view' || mode === 'print') {
            startViewMode(mode);
        } else if (mode === 'practice') {
            startPracticeMode();
        }
    }

    function goBack() {
        saveProgress();
        document.getElementById('app-view').style.display = 'none';
        document.getElementById('app-practice').style.display = 'none';
        document.getElementById('menu-screen').style.display = 'flex';
        
        document.body.style.overflow = 'hidden';
        document.body.classList.remove('view-mode-active');
        
        updateMenuProgress();
    }

    // ==========================================
    //  ä¸€è¦§ãƒ»å°åˆ·ãƒ¢ãƒ¼ãƒ‰ (User's Perfect UI)
    // ==========================================
    function startViewMode(mode) {
        document.getElementById('app-view').style.display = 'block';
        currentPage = 0;
        
        const container = document.getElementById('view-mode-container');
        container.innerHTML = '';

        if (mode === 'view') {
            document.body.classList.add('view-mode-active');
            isAllAnswersVisible = false;
            updateToggleBtnText();
            document.body.style.overflow = 'hidden';
            document.getElementById('nav-controls').style.display = 'block';
            document.getElementById('toggle-all-btn').style.display = 'inline-block';
            document.getElementById('header-hint-text').style.display = 'inline';
            renderViewPage();
        } else {
            // Print Mode
            document.body.classList.remove('view-mode-active');
            document.body.style.overflow = 'visible';
            document.getElementById('nav-controls').style.display = 'none';
            document.getElementById('toggle-all-btn').style.display = 'none';
            document.getElementById('header-hint-text').style.display = 'none';
            document.getElementById('page-info').innerText = "å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼";
            
            renderAllPages();
            setTimeout(() => { window.print(); }, 500);
        }
    }

    function createPageCanvas(pageData, pageIndex) {
        const canvas = document.createElement('div');
        canvas.className = 'view-canvas';
        
        const titleDiv = document.createElement('div');
        titleDiv.className = 'print-title';
        titleDiv.innerText = currentSheetName;
        canvas.appendChild(titleDiv);

        const grid = document.createElement('div');
        grid.className = 'kanji-table-grid';

        for (let i = 0; i < itemsPerPage; i++) {
            const item = pageData[i]; 
            // item ã¯ {q: "...", a: "..."}ã€‚IDã¯ç„¡ã„ã®ã§indexè¨ˆç®—
            const globalIndex = (pageIndex * itemsPerPage) + i;
            const isItemExists = !!item;
            
            const displayId = isItemExists ? (globalIndex + 1) : "&nbsp;";
            const displayQ  = isItemExists ? item.q : "\u3000"; 
            const displayA  = isItemExists ? item.a.replace(/[ã€,]/g, '<br>') : "\u3000"; // ã‚«ãƒ³ãƒæ”¹è¡Œå¯¾å¿œ
            
            const textVisClass = isItemExists ? "" : "invisible-text";
            const isHidden = (currentMode === 'view' && !isAllAnswersVisible);
            const hiddenClass = (isItemExists && isHidden) ? 'blind' : '';
            const hintClass = (isItemExists && isHidden) ? 'show-hint' : '';
            const clickAction = (currentMode === 'view' && isItemExists) ? `onclick="toggleSingleAnswer(this)"` : '';
            const cellCursorClass = (isItemExists) ? 'has-data' : ''; 
            
            const squareClass = isItemExists ? "square" : "square hidden";
            
            // é€²æ—ãƒãƒ¼ã‚¯ã®åˆ¤å®š
            let currentStatusVal = 0; // 0:ãªã—, 1:âœ”, 2:â–³
            if (isItemExists) {
                const prog = allProgress[currentSheetName];
                if (prog.perfect.includes(globalIndex)) currentStatusVal = 1;
                else if (prog.retry.includes(globalIndex)) currentStatusVal = 2;
            }

            const MARK_STATES = [
                { html: "" }, 
                { html: "<span class='square-mark mark-perfect'>âœ”</span>" }, 
                { html: "<span class='square-mark mark-review'>â–³</span>" }  
            ];
            const currentMarkHtml = MARK_STATES[currentStatusVal].html;
            
            const squareClick = (currentMode === 'view' && isItemExists) ? `onclick="toggleCheck(this, ${globalIndex})"` : '';

            const table = document.createElement('table');
            table.className = "column-unit";
            table.innerHTML = `
                <tr><td class="h-check">
                    <div class="${squareClass}" ${squareClick}>${currentMarkHtml}</div>
                </td></tr>
                <tr><td class="h-num"><span class="${textVisClass}">${displayId}</span></td></tr>
                <td class="h-ques">
                    <div class="ques-wrapper ${textVisClass}">${displayQ}</div>
                </td>
                <tr><td class="h-num2"><span class="${textVisClass}">${displayId}</span></td></tr>
                <td class="h-ans ${cellCursorClass}" ${clickAction}>
                    <div class="ans-wrapper ${hintClass}">
                        <span class="ans-text ${hiddenClass} ${textVisClass}">${displayA}</span>
                    </div>
                </td>
            `;
            grid.appendChild(table);
        }

        canvas.appendChild(grid);
        return canvas;
    }

    function toggleCheck(squareElem, globalIndex) {
        if (!squareElem) return;
        const prog = allProgress[currentSheetName];
        
        // ç¾åœ¨ã®çŠ¶æ…‹åˆ¤å®š
        let currentVal = 0;
        if (prog.perfect.includes(globalIndex)) currentVal = 1;
        else if (prog.retry.includes(globalIndex)) currentVal = 2;

        // æ¬¡ã®çŠ¶æ…‹ã¸ (0 -> 1 -> 2 -> 0)
        let nextVal = (currentVal + 1) % 3;

        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        if (nextVal === 1) { // Perfect
            if(!prog.perfect.includes(globalIndex)) prog.perfect.push(globalIndex);
            prog.retry = prog.retry.filter(i => i !== globalIndex);
        } else if (nextVal === 2) { // Retry
            if(!prog.retry.includes(globalIndex)) prog.retry.push(globalIndex);
            prog.perfect = prog.perfect.filter(i => i !== globalIndex);
        } else { // Clear
            prog.perfect = prog.perfect.filter(i => i !== globalIndex);
            prog.retry = prog.retry.filter(i => i !== globalIndex);
        }

        saveProgress();
        
        // UIæ›´æ–°
        const MARK_STATES = ["", "<span class='square-mark mark-perfect'>âœ”</span>", "<span class='square-mark mark-review'>â–³</span>"];
        squareElem.innerHTML = MARK_STATES[nextVal];
    }

    function toggleSingleAnswer(tdElement) {
        const span = tdElement.querySelector('.ans-text');
        const wrapper = tdElement.querySelector('.ans-wrapper');
        
        if (span && !span.classList.contains('invisible-text')) {
            span.classList.toggle('blind');
            wrapper.classList.toggle('show-hint');
        }
    }

    function toggleAllAnswers() {
        isAllAnswersVisible = !isAllAnswersVisible;
        const allWrappers = document.querySelectorAll('.ans-wrapper');
        const allSpans = document.querySelectorAll('.ans-text');
        
        allSpans.forEach(span => {
            if (span.classList.contains('invisible-text')) return; 
            if (isAllAnswersVisible) span.classList.remove('blind');
            else span.classList.add('blind');
        });
        
        allWrappers.forEach(wrapper => {
            const span = wrapper.querySelector('.ans-text');
            if (!span || span.classList.contains('invisible-text')) return;

            if (isAllAnswersVisible) wrapper.classList.remove('show-hint');
            else wrapper.classList.add('show-hint');
        });
        updateToggleBtnText();
    }

    function updateToggleBtnText() {
        const btn = document.getElementById('toggle-all-btn');
        btn.innerText = isAllAnswersVisible ? 'ç­”ãˆã‚’éš ã™' : 'ç­”ãˆã‚’è¡¨ç¤º';
        btn.style.background = isAllAnswersVisible ? '#333' : '#fff';
        btn.style.color = isAllAnswersVisible ? '#fff' : '#333';
    }

    function renderViewPage() {
        const container = document.getElementById('view-mode-container');
        container.innerHTML = '';
        const start = currentPage * itemsPerPage;
        const pageData = currentQuestions.slice(start, start + itemsPerPage);
        
        container.appendChild(createPageCanvas(pageData, currentPage));

        document.getElementById('page-info').innerText = `${start + 1} ã€œ ${Math.min(start + itemsPerPage, currentQuestions.length)} å•ç›® / å…¨${currentQuestions.length}å•`;
        document.getElementById('prevBtn').disabled = currentPage === 0;
        document.getElementById('nextBtn').disabled = (start + itemsPerPage) >= currentQuestions.length;
    }

    function renderAllPages() {
        const container = document.getElementById('view-mode-container');
        const totalPages = Math.ceil(currentQuestions.length / itemsPerPage);
        for (let i = 0; i < totalPages; i++) {
            const pageData = currentQuestions.slice(i * itemsPerPage, (i + 1) * itemsPerPage);
            container.appendChild(createPageCanvas(pageData, i));
        }
    }

    function changePage(step) {
        const maxPage = Math.ceil(currentQuestions.length / itemsPerPage) - 1;
        const nextPage = currentPage + step;
        if (nextPage < 0 || nextPage > maxPage) return;

        currentPage = nextPage;
        isAllAnswersVisible = false; 
        updateToggleBtnText();
        renderViewPage();
    }

    // ==========================================
    //  ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ (Practice Logic)
    // ==========================================
    function startPracticeMode() {
        document.getElementById('app-practice').style.display = 'grid';
        pCurrentIndex = allProgress[currentSheetName].lastIndex || 0;
        showPracticeQuestion();
    }

    function showPracticeQuestion() {
        if (pCurrentIndex >= currentQuestions.length) {
            if (confirm("æœ€å¾Œã¾ã§çµ‚ã‚ã‚Šã¾ã—ãŸï¼æœ€åˆã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) {
                pCurrentIndex = 0;
            } else {
                goBack();
                return;
            }
        }
        
        const q = currentQuestions[pCurrentIndex];
        document.getElementById('p-q-num').innerText = `ç¬¬ ${pCurrentIndex + 1} å• / å…¨${currentQuestions.length}å•`;
        document.getElementById('p-q-text').innerText = q.q;
        document.getElementById('p-ans-area').innerHTML = q.a.replace(/[ã€,]/g, '<br>');
        
        // ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('p-ans-area').style.visibility = 'hidden';
        document.getElementById('p-show-btn').style.display = 'block';
        document.getElementById('p-judge-btns').style.display = 'none';
        
        updatePracticeStats();
    }

    function showPracticeAnswer() {
        document.getElementById('p-ans-area').style.visibility = 'visible';
        document.getElementById('p-show-btn').style.display = 'none';
        document.getElementById('p-judge-btns').style.display = 'flex';
    }

    function recordPractice(type) {
        const prog = allProgress[currentSheetName];
        if (type === 'perfect') {
            if(!prog.perfect.includes(pCurrentIndex)) prog.perfect.push(pCurrentIndex);
            prog.retry = prog.retry.filter(i => i !== pCurrentIndex);
        } else {
            if(!prog.retry.includes(pCurrentIndex)) prog.retry.push(pCurrentIndex);
            prog.perfect = prog.perfect.filter(i => i !== pCurrentIndex);
        }
        
        pCurrentIndex++;
        prog.lastIndex = pCurrentIndex;
        saveProgress();
        showPracticeQuestion();
    }

    function updatePracticeStats() {
        const prog = allProgress[currentSheetName];
        document.getElementById('p-stat-total').innerText = `${pCurrentIndex + 1}/${currentQuestions.length}`;
        document.getElementById('p-stat-perfect').innerText = prog.perfect.length;
        document.getElementById('p-stat-retry').innerText = prog.retry.length;
    }

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œå¯¾å¿œ
    document.addEventListener('keydown', (e) => {
        if (currentMode === 'view' && document.getElementById('app-view').style.display === 'block') {
            if (e.key === 'ArrowRight') changePage(1);
            if (e.key === 'ArrowLeft') changePage(-1);
        }
    });

    // åˆå›å®Ÿè¡Œ
    init();

</script>
</body>
</html>
