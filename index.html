<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>漢字練習ツール（多機能版）</title>
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; font-family: "Hiragino Kaku Gothic ProN", "Yu Mincho", "MS PMincho", serif; background-color: #f0f4f8; }
        body { display: flex; flex-direction: column; align-items: center; padding: 10px; box-sizing: border-box; }
        .container { background: white; padding: 15px 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 98%; height: 98vh; display: flex; flex-direction: column; box-sizing: border-box; }
        h1 { font-size: 20px; color: #2c3e50; border-bottom: 2px solid #3498db; margin: 5px 0; padding-bottom: 5px; text-align: center; }
        .hidden { display: none; }
        #loading { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 18px; color: #7f8c8d; }
        #sheet-select, #mode-select { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow-y: auto; }
        #game-screen { flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; padding: 5px 0; }
        .card { border: 4px solid #3498db; border-radius: 20px; margin: 10px 0; flex-grow: 1; background-color: #fffdf0; display: flex; flex-direction: column; justify-content: center; text-align: center; min-height: 150px; }
        .q-text { font-family: "HG正楷書体-PRO", "HGP正楷書体", "YuMincho", serif; font-size: clamp(28px, 5.5vh, 44px); font-weight: 600; line-height: 1.4; padding: 0 20px; color: #2c3e50; }
        .a-text { font-family: "HG正楷書体-PRO", "HGP正楷書体", "YuMincho", serif; font-size: clamp(36px, 7.5vh, 60px); color: #e67e22; font-weight: 600; margin-top: 15px; min-height: 1.2em; }
        .action-area { height: 100px; display: flex; align-items: center; justify-content: center; }
        .btn-list { width: 85%; max-width: 400px; padding: 15px; margin: 5px; background: #3498db; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; }
        button.btn-main { cursor: pointer; background: #3498db; color: white; border: none; border-radius: 15px; width: 100%; max-width: 500px; height: 80px; font-size: 26px; font-weight: bold; }
        button.btn-green { cursor: pointer; background: #2ecc71; color: white; border: none; border-radius: 15px; width: 100%; max-width: 500px; height: 80px; font-size: 26px; font-weight: bold; }
        .highlight { color: #e74c3c; font-weight: bold; }
        .info-tag { font-size: 14px; color: #7f8c8d; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h1>漢字練習ツール</h1>
    <div id="loading">スプレッドシートを読み込み中...</div>

    <div id="quiz-area" class="hidden" style="flex-grow:1; display:flex; flex-direction:column;">
        
        <div id="sheet-select">
            <p style="font-weight: bold;">問題集をえらんでね</p>
            <div id="sheet-buttons" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
        </div>

        <div id="mode-select" class="hidden">
            <p id="selected-sheet-name" style="font-weight: bold; color:#3498db;"></p>
            <button class="btn-list" onclick="setMode('normal')">最初から（順番どおり）</button>
            <button class="btn-list" onclick="setMode('random')" style="background:#9b59b6;">ランダム（まぜこぜ）</button>
            <button onclick="backToSheetSelect()" style="margin-top:20px; background:none; border:none; text-decoration:underline; color:#7f8c8d;">選びなおす</button>
        </div>

        <div id="game-screen" class="hidden">
            <div id="info" class="info-tag"></div>
            <div class="card">
                <div id="q-text" class="q-text"></div>
                <div id="a-text" class="a-text"></div>
            </div>
            <div class="action-area">
                <button id="show-btn" class="btn-main" onclick="showAnswer()">答えを見る</button>
                <div id="judge-btns" class="hidden" style="width:100%; text-align:center;">
                    <button class="btn-green" onclick="nextStep()">次へすすむ ＞</button>
                </div>
            </div>
            <div style="text-align:center;">
                <button onclick="location.reload()" style="background:none; border:none; color: #95a5a6; font-size: 12px; text-decoration: underline; cursor:pointer;">メニューにもどる</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyWHprvWe-NcrfamWL2I6bWSAak6HW-JxyMCY-RZkZDFrhLkbSfLkeVmpKyznlI7g3a/exec";
    let allQuestions = {};
    let currentQuestions = [];
    let currentIndex = 0;

    window.onload = async function() {
        if (API_URL.includes("ここに")) return;
        try {
            const response = await fetch(API_URL);
            allQuestions = await response.json();
            
            const btnArea = document.getElementById('sheet-buttons');
            Object.keys(allQuestions).forEach(sheetName => {
                const btn = document.createElement('button');
                btn.className = 'btn-list';
                btn.innerText = sheetName;
                btn.onclick = () => selectSheet(sheetName);
                btnArea.appendChild(btn);
            });

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('quiz-area').classList.remove('hidden');
        } catch (e) {
            document.getElementById('loading').innerHTML = `<p style='color:red;'>読み込みエラー</p>`;
        }
    };

    function selectSheet(name) {
        currentQuestions = [...allQuestions[name]];
        document.getElementById('selected-sheet-name').innerText = "えらんだ問題：" + name;
        document.getElementById('sheet-select').classList.add('hidden');
        document.getElementById('mode-select').classList.remove('hidden');
    }

    function backToSheetSelect() {
        document.getElementById('mode-select').classList.add('hidden');
        document.getElementById('sheet-select').classList.remove('hidden');
    }

    function setMode(mode) {
        if(mode === 'random') currentQuestions.sort(() => Math.random() - 0.5);
        currentIndex = 0;
        document.getElementById('mode-select').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        showQuestion();
    }

    function showQuestion() {
        if(currentIndex >= currentQuestions.length) {
            alert("全部おわりました！");
            location.reload();
            return;
        }
        document.getElementById('info').innerText = `あと ${currentQuestions.length - currentIndex} 問 / 全 ${currentQuestions.length} 問`;
        let rawText = currentQuestions[currentIndex].q;
        let formattedText = rawText.replace(/（/g, '<span class="highlight">（').replace(/）/g, '）</span>').replace(/\(/g, '<span class="highlight">(').replace(/\)/g, ')</span>');
        document.getElementById('q-text').innerHTML = formattedText;
        document.getElementById('a-text').innerText = "";
        document.getElementById('show-btn').classList.remove('hidden');
        document.getElementById('judge-btns').classList.add('hidden');
    }

    function showAnswer() {
        document.getElementById('a-text').innerText = currentQuestions[currentIndex].a;
        document.getElementById('show-btn').classList.add('hidden');
        document.getElementById('judge-btns').classList.remove('hidden');
    }

    function nextStep() {
        currentIndex++;
        showQuestion();
    }
</script>
</body>
</html>
