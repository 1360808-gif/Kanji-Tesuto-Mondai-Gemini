<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¼¢å­—ãƒ—ãƒªãƒ³ãƒˆå†ç¾ç‰ˆ</title>
    <style>
        :root {
            --paper-bg: #fffdf5;
            --ink-black: #333;
            --main-font: "UD Digital Kyokasho N-R", "UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“ N-R", "BIZ UDPGothic", sans-serif;
        }

        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; background-color: #e0d8c3; font-family: var(--main-font); overflow: hidden; }

        /* --- ä¸€è¦§ç”»é¢ï¼ˆãƒ†ã‚¹ãƒˆãƒ—ãƒªãƒ³ãƒˆå®Œå…¨å†ç¾ï¼‰ --- */
        #list-view-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 200; overflow-x: auto; overflow-y: hidden;
            padding: 30px; writing-mode: vertical-rl; /* ç¸¦æ›¸ãè¨­å®š */
        }
        
        .print-page {
            display: inline-flex; height: 90vh; background: white;
            border: 2px solid #000; margin-left: 50px; padding: 0;
            position: relative;
        }

        /* å³ç«¯ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚·ãƒ¼ãƒˆåï¼‰ã‚¨ãƒªã‚¢ */
        .print-title-area {
            width: 80px; display: flex; align-items: center; justify-content: center;
            border-left: 2px solid #000; padding: 20px 10px;
        }
        .print-title { font-size: 26px; font-weight: bold; letter-spacing: 0.3em; line-height: 1.2; }

        .print-grid { display: flex; height: 100%; }

        /* å•é¡Œã®å„ã‚«ãƒ©ãƒ ï¼ˆç¸¦ã«ä¸€æœ¬ã®ç·šã§ã¤ãªãŒã‚‹ï¼‰ */
        .print-col {
            width: 65px; border-left: 1px solid #000; display: flex; flex-direction: column;
        }
        .print-col:last-child { border-right: none; }

        /* å„ãƒ‘ãƒ¼ãƒ„ã®é«˜ã•æŒ‡å®š */
        .checkbox-box {
            height: 60px; border-bottom: 1px solid #000;
            display: flex; align-items: center; justify-content: center;
        }
        .check-square {
            width: 32px; height: 32px; border: 2px solid #000;
            display: flex; align-items: center; justify-content: center; font-size: 24px; color: #2ecc71;
        }
        .num-box {
            height: 40px; border-bottom: 1px solid #000;
            display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold;
        }
        .q-box {
            flex-grow: 1; padding: 25px 5px; font-size: 19px; line-height: 1.8;
            border-bottom: 1px solid #000; display: flex; align-items: flex-start;
        }
        .a-box {
            height: 140px; padding: 10px 5px; font-size: 17px; font-weight: bold;
            display: flex; align-items: center; justify-content: center; color: #e74c3c;
            text-align: center;
        }

        #close-list-btn {
            position: fixed; top: 20px; right: 20px; writing-mode: horizontal-tb;
            z-index: 210; background: #ff4757; color: white; padding: 10px 20px;
            border-radius: 15px; cursor: pointer; border: 2px solid #000; font-weight: bold;
        }

        /* --- ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ãƒ»å­¦ç¿’ç”»é¢ç”¨ï¼ˆå‰å›ã®ã‚’ç¶­æŒï¼‰ --- */
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 20px; }
        #selector-screen { display: none; flex-direction: column; align-items: center; width: 100%; height: 100vh; padding: 40px; overflow-y: auto; }
        .sheet-row { display: flex; width: 100%; max-width: 500px; gap: 10px; margin-bottom: 10px; }
        .sheet-btn { flex-grow: 1; padding: 20px; font-size: 20px; border-radius: 15px; border: 3px solid #333; cursor: pointer; background: white; font-family: inherit; font-weight: bold; }
        #top-update-btn { position: absolute; top: 10px; left: 10px; background: #9b59b6; color: white; border: 2px solid #333; padding: 8px 12px; border-radius: 10px; cursor: pointer; }
        #resume-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; border: 4px solid #333; width: 320px; text-align: center; }
        .modal-btn { width: 100%; padding: 15px; margin: 5px 0; border: 2px solid #333; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer; font-family: inherit; }
    </style>
</head>
<body>

<div id="loading">âœ¨ èª­ã¿è¾¼ã¿ä¸­... âœ¨</div>
<button id="top-update-btn" onclick="fetchData(true)">ğŸ”„ ã“ã†ã—ã‚“</button>

<div id="list-view-screen">
    <button id="close-list-btn" onclick="closeListView()">Ã— é–‰ã˜ã‚‹</button>
    <div id="print-container"></div>
</div>

<div id="resume-modal">
    <div class="modal-content">
        <h3 id="modal-sheet-name" style="margin-top:0;"></h3>
        <button class="modal-btn" style="background:#3498db; color:white;" onclick="handleResumeChoice('resume')">ã¤ã¥ãã‹ã‚‰</button>
        <button class="modal-btn" style="background:#f1c40f;" onclick="handleResumeChoice('view')">å•é¡Œä¸€è¦§ã‚’è¦‹ã‚‹</button>
        <button class="modal-btn" style="background:#fff;" onclick="handleResumeChoice('restart')">ã¯ã˜ã‚ã‹ã‚‰</button>
        <button style="margin-top:10px; background:none; border:none; color:#999; text-decoration:underline;" onclick="document.getElementById('resume-modal').style.display='none'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<div id="selector-screen">
    <h2>ğŸ“– å•é¡Œé›†ã‚’ãˆã‚‰ã¶</h2>
    <div id="sheet-list"></div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyWHprvWe-NcrfamWL2I6bWSAak6HW-JxyMCY-RZkZDFrhLkbSfLkeVmpKyznlI7g3a/exec";
    const CACHE_KEY = "kanji_quiz_v32_print_fix";
    const PROGRESS_KEY = "kanji_quiz_progress";
    
    let allData = {};
    let allProgress = {};
    let pendingSheet = "";

    async function fetchData(force = false) {
        document.getElementById('loading').style.display = 'block';
        const savedProgress = localStorage.getItem(PROGRESS_KEY);
        if (savedProgress) {
            const parsed = JSON.parse(savedProgress);
            for (let key in parsed) {
                allProgress[key] = { perfect: new Set(parsed[key].perfect), lastIndex: parsed[key].lastIndex || 0 };
            }
        }
        const cached = localStorage.getItem(CACHE_KEY);
        if (!force && cached) { allData = JSON.parse(cached); createMenu(); return; }
        try {
            const res = await fetch(API_URL);
            allData = await res.json();
            localStorage.setItem(CACHE_KEY, JSON.stringify(allData));
            createMenu();
        } catch(e) { document.getElementById('loading').innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼"; }
    }

    function createMenu() {
        document.getElementById('loading').style.display = 'none';
        const list = document.getElementById('sheet-list');
        list.innerHTML = "";
        Object.keys(allData).forEach(key => {
            const row = document.createElement('div'); row.className = "sheet-row";
            const btn = document.createElement('button'); btn.className = "sheet-btn";
            btn.innerText = key;
            btn.onclick = () => selectSheet(key);
            row.appendChild(btn); list.appendChild(row);
        });
        document.getElementById('selector-screen').style.display = 'flex';
    }

    function selectSheet(sheetName) {
        pendingSheet = sheetName;
        document.getElementById('modal-sheet-name').innerText = sheetName;
        document.getElementById('resume-modal').style.display = 'flex';
    }

    function handleResumeChoice(choice) {
        document.getElementById('resume-modal').style.display = 'none';
        if (choice === 'view') showListView(pendingSheet);
        else alert("å­¦ç¿’ç”»é¢ï¼ˆæº–å‚™ä¸­ï¼‰ã¸ã€‚ä¸€è¦§è¡¨ç¤ºã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }

    function showListView(sheetName) {
        const questions = allData[sheetName];
        const prog = allProgress[sheetName] || { perfect: new Set() };
        const container = document.getElementById('print-container');
        container.innerHTML = "";
        
        // 15å•ãšã¤ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ
        for (let i = 0; i < questions.length; i += 15) {
            const chunk = questions.slice(i, i + 15);
            const page = document.createElement('div');
            page.className = "print-page";
            
            // å³ç«¯ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆè¦‹æœ¬é€šã‚Šï¼‰
            const titleArea = document.createElement('div');
            titleArea.className = "print-title-area";
            titleArea.innerHTML = `<div class="print-title">${sheetName}</div>`;
            page.appendChild(titleArea);

            const grid = document.createElement('div');
            grid.className = "print-grid";

            chunk.forEach((q, idx) => {
                const originalIndex = i + idx;
                const col = document.createElement('div');
                col.className = "print-col";
                
                // 1. â–¡ ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
                const isPerfect = prog.perfect.has(originalIndex);
                const cbBox = document.createElement('div');
                cbBox.className = "checkbox-box";
                cbBox.innerHTML = `<div class="check-square">${isPerfect ? 'âœ”' : ''}</div>`;
                
                // 2. å•é¡Œç•ªå·
                const nBox = document.createElement('div');
                nBox.className = "num-box";
                nBox.innerText = originalIndex + 1;

                // 3. å•é¡Œæ–‡ï¼ˆã‚«ãƒƒã‚³å†…ã‚’ç©ºæ¬„ã«ï¼‰
                const qBox = document.createElement('div');
                qBox.className = "q-box";
                // ã‚«ãƒƒã‚³ã‚’å¤§ããã‚ã‘ã‚‹
                qBox.innerHTML = q.q.replace(/[ï¼ˆ\(].*?[ï¼‰\)]/g, 'ï¼ˆã€€ã€€ã€€ï¼‰');

                // 4. ç­”ãˆ
                const aBox = document.createElement('div');
                aBox.className = "a-box";
                aBox.innerText = q.a;

                col.appendChild(cbBox);
                col.appendChild(nBox);
                col.appendChild(qBox);
                col.appendChild(aBox);
                grid.appendChild(col);
            });
            
            page.appendChild(grid);
            container.appendChild(page);
        }

        document.getElementById('list-view-screen').style.display = "block";
        document.getElementById('selector-screen').style.display = "none";
    }

    function closeListView() {
        document.getElementById('list-view-screen').style.display = "none";
        document.getElementById('selector-screen').style.display = "flex";
    }

    fetchData();
</script>
</body>
</html>
