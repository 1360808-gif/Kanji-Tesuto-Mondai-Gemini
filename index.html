<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¼¢å­—ãƒ—ãƒªãƒ³ãƒˆå†ç¾ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        :root {
            --paper-bg: #ffffff;
            --ink-black: #000000;
            --perfect-green: #27ae60;
            --main-font: "UD Digital Kyokasho N-R", "UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“ N-R", "BIZ UDPGothic", sans-serif;
        }

        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; background-color: #e0d8c3; font-family: var(--main-font); overflow: hidden; }

        /* --- ãƒ—ãƒªãƒ³ãƒˆç”»é¢ --- */
        #list-view-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 200; overflow-x: auto; overflow-y: hidden;
            padding: 20px; writing-mode: vertical-rl;
        }
        
        .print-page {
            display: inline-flex; height: 92vh; background: white;
            border: 2px solid var(--ink-black); margin-left: 40px; padding: 0;
            position: relative;
        }

        /* å³ç«¯ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚¨ãƒªã‚¢ */
        .print-title-area {
            width: 70px; display: flex; align-items: center; justify-content: center;
            border-left: 2px solid var(--ink-black); padding: 20px 5px;
        }
        .print-title { font-size: 24px; font-weight: bold; letter-spacing: 0.2em; }

        .print-grid { display: flex; height: 100%; }

        /* å•é¡Œã®å„ã‚«ãƒ©ãƒ ï¼ˆä¸€æœ¬ã®å¤ªã„æ ã®ã‚ˆã†ã«è¦‹ã›ã‚‹ï¼‰ */
        .print-col {
            width: 60px; border-left: 1px solid var(--ink-black); display: flex; flex-direction: column;
        }

        /* 1. â–¡ ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚¨ãƒªã‚¢ */
        .checkbox-box {
            height: 55px; border-bottom: 1px solid var(--ink-black);
            display: flex; align-items: center; justify-content: center;
        }
        .check-square {
            width: 28px; height: 28px; border: 2px solid var(--ink-black);
            display: flex; align-items: center; justify-content: center; font-size: 22px; color: var(--perfect-green);
        }

        /* 2. å•é¡Œç•ªå·ï¼ˆä¸Šï¼‰ */
        .num-box-top {
            height: 35px; border-bottom: 1px solid var(--ink-black);
            display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;
        }

        /* 3. å•é¡Œã‚¨ãƒªã‚¢ï¼ˆé•·ã„ï¼‰ */
        .q-box {
            flex-grow: 1; padding: 20px 4px; font-size: 18px; line-height: 1.7;
            border-bottom: 2px solid var(--ink-black); /* ç­”ãˆã¨ã®å¢ƒç•Œç·šã‚’å¤ªã‚ã« */
            display: flex; align-items: flex-start;
        }

        /* 4. å•é¡Œç•ªå·ï¼ˆä¸‹ï¼šç­”ãˆç”¨ï¼‰ */
        .num-box-bottom {
            height: 30px; border-bottom: 1px solid var(--ink-black);
            display: flex; align-items: center; justify-content: center; font-size: 12px; background: #f9f9f9;
        }

        /* 5. ç­”ãˆã‚¨ãƒªã‚¢ï¼ˆçŸ­ã„ï¼‰ */
        .a-box {
            height: 120px; padding: 10px 4px; font-size: 16px; font-weight: bold;
            display: flex; align-items: center; justify-content: center; color: #e74c3c;
            text-align: center;
        }

        /* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ */
        #close-list-btn {
            position: fixed; top: 15px; right: 15px; writing-mode: horizontal-tb;
            z-index: 210; background: #ff4757; color: white; padding: 8px 18px;
            border-radius: 20px; cursor: pointer; border: 2px solid #000; font-weight: bold;
        }

        /* --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç­‰ --- */
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 20px; }
        #selector-screen { display: none; flex-direction: column; align-items: center; width: 100%; padding: 40px; }
        .sheet-btn { width: 100%; max-width: 400px; padding: 20px; margin-bottom: 10px; font-size: 20px; border: 3px solid #333; border-radius: 15px; cursor: pointer; background: #fff; font-weight: bold; }
        #resume-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; border: 4px solid #333; width: 300px; text-align: center; }
        .modal-btn { width: 100%; padding: 12px; margin: 5px 0; border: 2px solid #333; border-radius: 25px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="loading">èª­ã¿è¾¼ã¿ä¸­...</div>

<div id="list-view-screen">
    <button id="close-list-btn" onclick="closeListView()">Ã— ã¨ã˜ã‚‹</button>
    <div id="print-container"></div>
</div>

<div id="resume-modal">
    <div class="modal-content">
        <h3 id="modal-sheet-name"></h3>
        <button class="modal-btn" style="background:#f1c40f;" onclick="handleResumeChoice('view')">å•é¡Œä¸€è¦§ã‚’è¦‹ã‚‹</button>
        <button class="modal-btn" style="background:#3498db; color:white;" onclick="handleResumeChoice('start')">ç·´ç¿’ã‚’ã¯ã˜ã‚ã‚‹</button>
        <button style="margin-top:10px; background:none; border:none; color:#999; text-decoration:underline; cursor:pointer;" onclick="document.getElementById('resume-modal').style.display='none'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<div id="selector-screen">
    <h2>ğŸ“– æ¼¢å­—ã‚·ãƒ¼ãƒˆã‚’ãˆã‚‰ã¶</h2>
    <div id="sheet-list" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyWHprvWe-NcrfamWL2I6bWSAak6HW-JxyMCY-RZkZDFrhLkbSfLkeVmpKyznlI7g3a/exec";
    const CACHE_KEY = "kanji_quiz_v33_final_layout";
    const PROGRESS_KEY = "kanji_quiz_progress";
    
    let allData = {};
    let allProgress = {};
    let pendingSheet = "";

    async function fetchData() {
        const saved = localStorage.getItem(PROGRESS_KEY);
        if (saved) {
            const parsed = JSON.parse(saved);
            for (let key in parsed) {
                allProgress[key] = { perfect: new Set(parsed[key].perfect) };
            }
        }
        try {
            const res = await fetch(API_URL);
            allData = await res.json();
            localStorage.setItem(CACHE_KEY, JSON.stringify(allData));
            createMenu();
        } catch(e) { document.getElementById('loading').innerText = "ã‚¨ãƒ©ãƒ¼"; }
    }

    function createMenu() {
        document.getElementById('loading').style.display = 'none';
        const list = document.getElementById('sheet-list');
        list.innerHTML = "";
        Object.keys(allData).forEach(key => {
            const btn = document.createElement('button');
            btn.className = "sheet-btn";
            btn.innerText = key;
            btn.onclick = () => { pendingSheet = key; document.getElementById('modal-sheet-name').innerText = key; document.getElementById('resume-modal').style.display='flex'; };
            list.appendChild(btn);
        });
        document.getElementById('selector-screen').style.display = 'flex';
    }

    function handleResumeChoice(choice) {
        document.getElementById('resume-modal').style.display = 'none';
        if (choice === 'view') showListView(pendingSheet);
        else alert("ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã¸ï¼ˆã“ã“ã¯ä»¥å‰ã®å­¦ç¿’ã‚³ãƒ¼ãƒ‰ã¨åˆä½“ã•ã›ã¦ãã ã•ã„ï¼‰");
    }

    function showListView(sheetName) {
        const questions = allData[sheetName];
        const prog = allProgress[sheetName] || { perfect: new Set() };
        const container = document.getElementById('print-container');
        container.innerHTML = "";
        
        for (let i = 0; i < questions.length; i += 15) {
            const chunk = questions.slice(i, i + 15);
            const page = document.createElement('div');
            page.className = "print-page";
            
            const titleArea = document.createElement('div');
            titleArea.className = "print-title-area";
            titleArea.innerHTML = `<div class="print-title">${sheetName}</div>`;
            page.appendChild(titleArea);

            const grid = document.createElement('div');
            grid.className = "print-grid";

            chunk.forEach((q, idx) => {
                const originalIndex = i + idx;
                const col = document.createElement('div');
                col.className = "print-col";
                
                const isPerfect = prog.perfect.has(originalIndex);
                
                col.innerHTML = `
                    <div class="checkbox-box"><div class="check-square">${isPerfect ? 'âœ”' : ''}</div></div>
                    <div class="num-box-top">${originalIndex + 1}</div>
                    <div class="q-box">${q.q.replace(/[ï¼ˆ\(].*?[ï¼‰\)]/g, 'ï¼ˆã€€ã€€ã€€ï¼‰')}</div>
                    <div class="num-box-bottom">${originalIndex + 1}</div>
                    <div class="a-box">${q.a}</div>
                `;
                grid.appendChild(col);
            });
            
            page.appendChild(grid);
            container.appendChild(page);
        }
        document.getElementById('list-view-screen').style.display = "block";
    }

    function closeListView() { document.getElementById('list-view-screen').style.display = "none"; }
    fetchData();
</script>
</body>
</html>
