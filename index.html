<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>漢字練習クラウド</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background-color: #f0f4f8; display: flex; flex-direction: column; align-items: center; padding: 20px; color: #333; }
        .container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
        h1 { color: #2c3e50; font-size: 22px; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .hidden { display: none; }
        button { cursor: pointer; padding: 12px 20px; border: none; border-radius: 10px; font-size: 16px; margin: 8px 4px; transition: all 0.2s; font-weight: bold; }
        .btn-blue { background: #3498db; color: white; width: 100%; max-width: 200px; }
        .btn-blue:hover { background: #2980b9; transform: translateY(-2px); }
        .btn-green { background: #2ecc71; color: white; width: 45%; }
        .btn-red { background: #e74c3c; color: white; width: 45%; }
        select { padding: 12px; font-size: 16px; width: 100%; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 20px; appearance: none; background-color: #fff; }
        .card { border: 4px solid #3498db; border-radius: 20px; padding: 50px 20px; margin: 20px 0; background: #fff; position: relative; }
        .q-text { font-size: 32px; font-weight: bold; margin-bottom: 25px; line-height: 1.4; }
        .a-text { font-size: 40px; color: #e67e22; font-weight: bold; min-height: 1.2em; border-top: 1px dashed #eee; padding-top: 15px; }
        .loading { color: #3498db; font-weight: bold; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .status-info { font-size: 14px; color: #7f8c8d; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>漢字練習クラウド</h1>
    
    <div id="setup-area">
        <p id="msg" class="loading">スプレッドシートから問題を読み込んでいます...</p>
        <div id="menu" class="hidden">
            <p style="margin-bottom:10px; font-weight:bold;">1. 練習するセットを選ぼう</p>
            <select id="group-select"></select>
            
            <p style="margin-bottom:10px; font-weight:bold;">2. 練習モードを選ぼう</p>
            <div style="display: flex; flex-wrap: wrap; justify-content: center;">
                <button class="btn-blue" onclick="start('normal')">最初から</button>
                <button class="btn-blue" onclick="start('random')">ランダム</button>
                <button class="btn-blue" onclick="start('wrong')" id="btn-wrong-only">間違えた問題のみ</button>
            </div>
        </div>
    </div>

    <div id="quiz-area" class="hidden">
        <div class="status-info">残り: <span id="remaining-count">0</span>問</div>
        <div class="card">
            <div id="q-text" class="q-text"></div>
            <div id="a-text" class="a-text"></div>
        </div>
        
        <div id="action-area">
            <button id="show-btn" class="btn-blue" style="max-width:100%; width:100%; height:60px; font-size:20px;" onclick="showAnswer()">答えを見る</button>
            <div id="judge-btns" class="hidden">
                <p style="margin-bottom:10px; font-size:14px; color:#666;">書けましたか？</p>
                <button class="btn-green" onclick="judge(true)">〇 正解！</button>
                <button class="btn-red" onclick="judge(false)">× 間違えた</button>
            </div>
        </div>
        
        <button onclick="location.reload()" style="background:none; color: #95a5a6; margin-top:30px; text-decoration: underline; font-size:14px;">メニュー（セット選択）に戻る</button>
    </div>
</div>

<script>
    /**
     * 【重要】ここにスプレッドシートで発行したウェブアプリURLを貼り付けてください
     */
    const API_URL = "https://script.google.com/a/macros/fuku-c.ed.jp/s/AKfycbytHXD78P08pA4Vy3xb8T2ePq-5OZYRx0mipYsxGi1fM41k6in9Scmj8B-jUjxkEVbG/exec"; 

    let allData = [];
    let currentQueue = [];
    let currentIndex = 0;
    let wrongIds = new Set();

    // ページを開いた時にデータを自動取得
    window.onload = () => {
        if (API_URL === "ここにURLを貼り付け") {
            document.getElementById('msg').innerText = "エラー：URLが設定されていません。コードの48行目を確認してください。";
            return;
        }

        fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                allData = data;
                initMenu();
            })
            .catch(err => {
                document.getElementById('msg').innerText = "通信エラー：スプレッドシートにアクセスできません。";
                console.error(err);
            });

        // 過去の間違えた問題をブラウザから読み込み
        const saved = localStorage.getItem('kanji_wrong_list');
        if(saved) wrongIds = new Set(JSON.parse(saved));
    };

    // メニューの作成
    function initMenu() {
        // 空の行を無視して、有効なデータがあるシート名だけを抽出
        const validData = allData.filter(item => item.問題 && item.答え);
        allData = validData;

        const groups = [...new Set(allData.map(item => item.グループ))];
        const select = document.getElementById('group-select');
        
        if (groups.length === 0) {
            document.getElementById('msg').innerText = "問題が見つかりません。スプレッドシートを確認してください。";
            return;
        }

        groups.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g;
            opt.innerText = g;
            select.appendChild(opt);
        });
        
        document.getElementById('setup-area').querySelector('#msg').classList.add('hidden');
        document.getElementById('menu').classList.remove('hidden');
    }

    // 練習スタート
    function start(mode) {
        const selectedGroup = document.getElementById('group-select').value;
        let filtered = allData.filter(item => item.グループ === selectedGroup);

        if(mode === 'random') {
            filtered.sort(() => Math.random() - 0.5);
        } else if(mode === 'wrong') {
            filtered = filtered.filter(item => wrongIds.has(`${item.グループ}-${item.問題}`));
            if(filtered.length === 0) {
                alert("このセットで間違えた問題は登録されていません！");
                return;
            }
        }

        currentQueue = filtered;
        currentIndex = 0;
        document.getElementById('setup-area').classList.add('hidden');
        document.getElementById('quiz-area').classList.remove('hidden');
        showQuestion();
    }

    // 問題を表示
    function showQuestion() {
        if(currentIndex >= currentQueue.length) {
            alert("お疲れ様でした！すべての問題が終わりました。");
            location.reload();
            return;
        }
        document.getElementById('remaining-count').innerText = currentQueue.length - currentIndex;
        document.getElementById('q-text').innerText = currentQueue[currentIndex].問題;
        document.getElementById('a-text').innerText = "";
        document.getElementById('show-btn').classList.remove('hidden');
        document.getElementById('judge-btns').classList.add('hidden');
    }

    // 答えを表示
    function showAnswer() {
        document.getElementById('a-text').innerText = currentQueue[currentIndex].答え;
        document.getElementById('show-btn').classList.add('hidden');
        document.getElementById('judge-btns').classList.remove('hidden');
    }

    // 正解・不正解の判定保存
    function judge(isCorrect) {
        const item = currentQueue[currentIndex];
        const key = `${item.グループ}-${item.問題}`; // セット名と問題文を組み合わせて保存
        
        if(isCorrect) {
            wrongIds.delete(key);
        } else {
            wrongIds.add(key);
        }
        
        // ローカルストレージに保存（子どもごとのブラウザに保存される）
        localStorage.setItem('kanji_wrong_list', JSON.stringify([...wrongIds]));
        
        currentIndex++;
        showQuestion();
    }
</script>
</body>
</html>
